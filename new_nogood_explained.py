"""
new_nogood_explained.py â€” new-nogood í•¨ìˆ˜ì˜ ì„¤ê³„ ì˜ë„ì™€ ë™ì‘ ì›ë¦¬
=================================================================

â–  ì¼ìƒ ë¹„ìœ : "ê¸ˆì§€ ì‹ì¬ë£Œ ì¡°í•©" ì‹œìŠ¤í…œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ì…°í”„(ATMS)ê°€ ì‹ì¬ë£Œ(ê°€ì •)ë¥¼ ì¡°í•©í•´ì„œ ìš”ë¦¬(ê²°ë¡ )ë¥¼ ë§Œë“ ë‹¤.
  ê·¸ëŸ°ë° ì–´ëŠ ë‚  "ë•…ì½© + ìƒˆìš°ëŠ” í•¨ê»˜ ì“°ë©´ ë…ì´ ëœë‹¤"ëŠ” ì‚¬ì‹¤ì„ ë°œê²¬!

  ì´ë•Œ ì…°í”„ê°€ í•´ì•¼ í•  ì¼ 5ê°€ì§€ê°€ ë°”ë¡œ new-nogoodì˜ 5ë‹¨ê³„ë‹¤:

    â‘  ê¸ˆì§€ ë„ì¥:   "ë•…ì½©+ìƒˆìš°" ì¡°í•©ì— "ë…!" ë”±ì§€ë¥¼ ë¶™ì¸ë‹¤
    â‘¡ ë©”ë‰´ íšŒìˆ˜:   ì´ ì¡°í•©ì„ ì“´ ëª¨ë“  ìš”ë¦¬ë¥¼ ë©”ë‰´íŒì—ì„œ ë‚´ë¦°ë‹¤
    â‘¢ ê¸ˆì§€ ëª©ë¡:   "ê¸ˆì§€ ì¡°í•© ëª©ë¡"ì— ë“±ë¡í•œë‹¤
    â‘£ ì¤‘ë³µ ì •ë¦¬:   ì´ë¯¸ "ë•…ì½©+ìƒˆìš°+ìš°ìœ "ê°€ ê¸ˆì§€ì˜€ë‹¤ë©´?
                   "ë•…ì½©+ìƒˆìš°"ê°€ ë” ì‘ìœ¼ë‹ˆê¹Œ í° ê±´ ì œê±° (ìµœì†Œì„±)
    â‘¤ ì—°ì‡„ ì˜¤ì—¼:   "ë•…ì½©+ìƒˆìš°+ë‹¬ê±€" ê°™ì€ ìƒìœ„ ì¡°í•©ë„ ìë™ ê¸ˆì§€!

â–  ì €ì de Kleerì˜ ì„¤ê³„ ì˜ë„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. ê²Œìœ¼ë¥¸ ê°±ì‹ (Lazy Update):
     ëª¨ë“  í™˜ê²½ì„ ë§¤ë²ˆ ì „ìˆ˜ê²€ì‚¬í•˜ì§€ ì•ŠëŠ”ë‹¤.
     nogoodì´ ë°œìƒí•  ë•Œë§Œ ê·¸ ì˜í–¥ì„ í•œ ë²ˆì— ì „íŒŒí•œë‹¤.
     â†’ O(nÂ²) ëŒ€ì‹  ë°œìƒ ì‹œì ì—ë§Œ O(k) ì²˜ë¦¬

  2. ìµœì†Œì„±(Minimality) ìœ ì§€:
     nogood-tableì—ëŠ” ìµœì†Œ ì§‘í•©ë§Œ ë³´ê´€í•œë‹¤.
     {A,B}ê°€ nogoodì´ë©´ {A,B,C}ëŠ” ë‹¹ì—°íˆ nogoodì´ë¯€ë¡œ
     ì €ì¥í•  í•„ìš”ê°€ ì—†ë‹¤.
     â†’ ë©”ëª¨ë¦¬ ì ˆì•½ + ê²€ì‚¬ ì†ë„ í–¥ìƒ

  3. ìƒí–¥ ì˜¤ì—¼(Upward Contamination):
     ì‘ì€ nogoodì´ ë°œê²¬ë˜ë©´ ì´ë¥¼ í¬í•¨í•˜ëŠ” ëª¨ë“  í° í™˜ê²½ë„
     ìë™ìœ¼ë¡œ ì˜¤ì—¼ì‹œí‚¨ë‹¤. ë³„ë„ì˜ ê²€ì‚¬ ì—†ì´ ì¦‰ì‹œ ë¬´íš¨í™”.
     â†’ "í•œ ë²ˆì— ë‹¤ ì²˜ë¦¬" ì›ì¹™

  4. labelì—ì„œ ì¦‰ì‹œ ì œê±°:
     nogood í™˜ê²½ì´ ì–´ë–¤ ë…¸ë“œì˜ labelì— ë‚¨ì•„ìˆìœ¼ë©´
     ì´í›„ weaveì—ì„œ ì˜ëª»ëœ ì¶”ë¡ ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
     â†’ ë°œê²¬ ì¦‰ì‹œ ëª¨ë“  labelì—ì„œ ì œê±°

â–  ì›ë³¸ ì½”ë“œ (atms.lisp:367-406):

  (defun new-nogood (atms cenv just &aux count)
    ;;                  ^^^^        ^^^^
    ;;                  ê¸ˆì§€í™˜ê²½    ì´ìœ (justification)
    ;;
    (setf (env-nogood? cenv) just)                    ;; â‘  ê¸ˆì§€ ë„ì¥
    (remove-env-from-labels cenv atms)                ;; â‘¡ labelì—ì„œ ì œê±°
    (setf (atms-nogood-table atms)                    ;; â‘¢ nogood-table ë“±ë¡
          (insert-in-table ... cenv))
    (setq count (env-count cenv))
    (dolist (entry (atms-nogood-table atms))          ;; â‘£ ìƒìœ„ nogood ì •ë¦¬
      (when (> (car entry) count)                     ;;   í¬ê¸°ê°€ ë” í° ê²ƒë§Œ ê²€ì‚¬
        (dolist (old (cdr entry))
          (if (subset-env? cenv old)                  ;;   cenv âŠ† old?
              (delete old ...)))))                    ;;   â†’ ì œê±° (ìµœì†Œì„±)
    (dolist (entry (atms-env-table atms))             ;; â‘¤ ìƒí–¥ ì˜¤ì—¼
      (when (> (car entry) count)                     ;;   í¬ê¸°ê°€ ë” í° ê²ƒë§Œ ê²€ì‚¬
        (dolist (old (cdr entry))
          (when (and (not (env-nogood? old))           ;;   ì•„ì§ ìœ íš¨í•˜ê³ 
                     (subset-env? cenv old))           ;;   cenv âŠ† old?
            (setf (env-nogood? old) cenv)              ;;   â†’ ì˜¤ì—¼!
            (remove-env-from-labels old atms))))))     ;;   â†’ label ì œê±°

Mock ì‹œë‚˜ë¦¬ì˜¤:
  Mock 1: ê¸°ë³¸ â€” ê¸ˆì§€ ë„ì¥ + label ì œê±° + ë“±ë¡
  Mock 2: ìƒí–¥ ì˜¤ì—¼ â€” ì‘ì€ ê¸ˆì§€ê°€ í° í™˜ê²½ì„ ìë™ ì˜¤ì—¼
  Mock 3: ìµœì†Œì„± ì •ë¦¬ â€” ë” ì‘ì€ nogoodì´ í° nogoodì„ ëŒ€ì²´
  Mock 4: ì‹¤ì „ ì¢…í•© â€” ë‹¤ë‹¨ê³„ ì¶”ë¡  ë„¤íŠ¸ì›Œí¬ì—ì„œì˜ ì—°ì‡„ ë°˜ì‘
"""

from __future__ import annotations
from typing import Optional, List, Any, FrozenSet


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ë°ì´í„° íƒ€ì…
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class Env:
    """í™˜ê²½ â€” ê°€ì •ë“¤ì˜ ì§‘í•©. í•˜ë‚˜ì˜ 'ê°€ëŠ¥í•œ ì„¸ê³„'."""
    _counter = 0

    def __init__(self, assumptions: FrozenSet[str]):
        Env._counter += 1
        self.index = Env._counter
        self.assumptions = assumptions
        self.count = len(assumptions)
        self.nogood: Any = None        # Noneì´ë©´ ìœ íš¨, ì•„ë‹ˆë©´ ê¸ˆì§€ ì´ìœ 
        self.nodes: List[Node] = []    # ì´ envë¥¼ labelì— ê°€ì§„ ë…¸ë“œë“¤

    def is_nogood(self) -> bool:
        return self.nogood is not None

    def __repr__(self) -> str:
        content = "+".join(sorted(self.assumptions)) if self.assumptions else "âˆ…"
        mark = f"âœ—({self.nogood})" if self.is_nogood() else ""
        return f"E{{{content}}}{mark}"

    def assumptions_str(self) -> str:
        if not self.assumptions:
            return "{âˆ…}"
        return "{" + ", ".join(sorted(self.assumptions)) + "}"

    def __eq__(self, other):
        return isinstance(other, Env) and self.assumptions == other.assumptions

    def __hash__(self):
        return hash(self.assumptions)

    @staticmethod
    def reset():
        Env._counter = 0


class Node:
    """TMS ë…¸ë“œ â€” í•˜ë‚˜ì˜ ëª…ì œ(belief)."""
    def __init__(self, name: str):
        self.name = name
        self.label: List[Env] = []
        self.assumption = False

    def __repr__(self):
        return self.name

    def label_str(self) -> str:
        if not self.label:
            return "[]"
        return "[" + ", ".join(str(e) for e in self.label) + "]"


class ATMS:
    """ATMS ì—”ì§„ â€” í™˜ê²½ í…Œì´ë¸”, nogood í…Œì´ë¸” ê´€ë¦¬."""
    def __init__(self):
        self.env_table: List[Env] = []
        self.nogood_table: List[Env] = []
        self.nodes: List[Node] = []

    def make_env(self, assumptions: FrozenSet[str]) -> Env:
        for e in self.env_table:
            if e.assumptions == assumptions:
                return e
        env = Env(assumptions)
        self.env_table.append(env)
        return env

    def make_node(self, name: str, assumption: bool = False) -> Node:
        node = Node(name)
        node.assumption = assumption
        self.nodes.append(node)
        if assumption:
            env = self.make_env(frozenset({name}))
            node.label.append(env)
            env.nodes.append(node)
        return node

    def add_to_label(self, node: Node, env: Env):
        """ë…¸ë“œì˜ labelì— í™˜ê²½ì„ ì¶”ê°€í•˜ê³  ì—­ì°¸ì¡°ë„ ë“±ë¡."""
        if env not in node.label:
            node.label.append(env)
            if node not in env.nodes:
                env.nodes.append(node)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # new-nogood: 5ë‹¨ê³„ ì²˜ë¦¬ â€” ë‹¨ê³„ë³„ ì¶”ì  ë²„ì „
    # ì›ë³¸: atms.lisp:367-385
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    def new_nogood(self, cenv: Env, reason: str) -> None:
        """
        new-nogoodì˜ 5ë‹¨ê³„ë¥¼ í•˜ë‚˜ì”© ì‹¤í–‰í•˜ë©° ì¶”ì í•©ë‹ˆë‹¤.

        ë§¤ê°œë³€ìˆ˜:
          cenv   â€” ê¸ˆì§€í•  í™˜ê²½ (contradictory environment)
          reason â€” ê¸ˆì§€ ì´ìœ  (justificationì˜ informant)
        """
        count = cenv.count

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # â‘  ê¸ˆì§€ ë„ì¥ (Mark)
        # ì›ë³¸: (setf (env-nogood? cenv) just)
        #
        # ì„¤ê³„ ì˜ë„:
        #   env ìì²´ì— "ì™œ ê¸ˆì§€ë˜ì—ˆëŠ”ê°€"ë¥¼ ê¸°ë¡í•œë‹¤.
        #   ë‚˜ì¤‘ì— ì´ envë¥¼ ë§Œë‚˜ë©´ ì¦‰ì‹œ nogoodì„ì„ ì•Œ ìˆ˜ ìˆë‹¤.
        #   just(ì´ìœ )ë¥¼ ì €ì¥í•˜ëŠ” ì´ìœ : ë””ë²„ê¹… + ì„¤ëª… ìƒì„±ìš©.
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        print(f"  â”‚")
        print(f"  â”‚  â‘  ê¸ˆì§€ ë„ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        print(f"  â”‚     (setf (env-nogood? cenv) just)")
        print(f"  â”‚")
        print(f"  â”‚     ëŒ€ìƒ: {cenv}")
        print(f"  â”‚     ì´ìœ : '{reason}'")

        cenv.nogood = reason

        print(f"  â”‚     ê²°ê³¼: {cenv}")
        print(f"  â”‚")
        print(f"  â”‚     ğŸ’¡ ì„¤ê³„ ì˜ë„: envì— 'ì™œ ê¸ˆì§€?'ë¥¼ ê¸°ë¡í•´ ë‘”ë‹¤.")
        print(f"  â”‚        ì´í›„ ì´ envë¥¼ ë§Œë‚˜ë©´ ì¦‰ì‹œ nogood íŒë³„ ê°€ëŠ¥.")
        print(f"  â”‚        ì´ìœ ë¥¼ ì €ì¥í•˜ë©´ 'ì™œ ëª¨ìˆœì¸ì§€' ì„¤ëª…ë„ ê°€ëŠ¥.")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # â‘¡ labelì—ì„œ ì œê±° (Remove from labels)
        # ì›ë³¸: (remove-env-from-labels cenv atms)
        #
        # ì„¤ê³„ ì˜ë„:
        #   ì´ envê°€ ì–´ë–¤ ë…¸ë“œì˜ labelì— ë‚¨ì•„ìˆìœ¼ë©´
        #   "ì´ ë…¸ë“œëŠ” ì´ ì„¸ê³„ì—ì„œ ì°¸"ì´ë¼ëŠ” ì˜ëª»ëœ ì •ë³´ê°€ ëœë‹¤.
        #   ëª¨ìˆœ ì„¸ê³„ì—ì„œ ì°¸ì´ë¼ëŠ” ê±´ ì˜ë¯¸ê°€ ì—†ìœ¼ë¯€ë¡œ ì¦‰ì‹œ ì œê±°.
        #
        #   env.nodes (ì—­ì°¸ì¡° ë¦¬ìŠ¤íŠ¸) ë•ë¶„ì— O(k)ë¡œ ë¹ ë¥´ê²Œ ì²˜ë¦¬.
        #   ëª¨ë“  ë…¸ë“œë¥¼ ìˆœíšŒí•  í•„ìš” ì—†ì´, ì´ envë¥¼ ì°¸ì¡°í•˜ëŠ”
        #   ë…¸ë“œë§Œ ì°¾ì•„ì„œ ì œê±°í•˜ë©´ ëœë‹¤.
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        print(f"  â”‚")
        print(f"  â”‚  â‘¡ labelì—ì„œ ì œê±° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        print(f"  â”‚     (remove-env-from-labels cenv atms)")
        print(f"  â”‚")

        affected_nodes = list(cenv.nodes)
        if affected_nodes:
            print(f"  â”‚     {cenv.assumptions_str()}ë¥¼ labelì— ê°€ì§„ ë…¸ë“œë“¤:")
            for node in affected_nodes:
                old_label = node.label_str()
                if cenv in node.label:
                    node.label.remove(cenv)
                print(f"  â”‚       {node.name}.label: {old_label} â†’ {node.label_str()}")
            cenv.nodes.clear()
        else:
            print(f"  â”‚     ì´ envë¥¼ labelì— ê°€ì§„ ë…¸ë“œ ì—†ìŒ (ì œê±°í•  ê²ƒ ì—†ìŒ)")

        print(f"  â”‚")
        print(f"  â”‚     ğŸ’¡ ì„¤ê³„ ì˜ë„: ëª¨ìˆœ ì„¸ê³„ì—ì„œ 'ì°¸'ì´ë¼ëŠ” ê±´ ë¬´ì˜ë¯¸.")
        print(f"  â”‚        ì¦‰ì‹œ ì œê±°í•˜ì§€ ì•Šìœ¼ë©´ ì´í›„ weaveì—ì„œ ì˜ëª»ëœ")
        print(f"  â”‚        ì¶”ë¡ ì´ ì „íŒŒë  ìˆ˜ ìˆë‹¤.")
        print(f"  â”‚        env.nodes(ì—­ì°¸ì¡°)ë¡œ O(k) ë¹ ë¥¸ ì œê±° ê°€ëŠ¥.")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # â‘¢ nogood-tableì— ë“±ë¡ (Register)
        # ì›ë³¸: (setf (atms-nogood-table atms)
        #             (insert-in-table ... cenv))
        #
        # ì„¤ê³„ ì˜ë„:
        #   ìƒˆë¡œ ë§Œë“¤ì–´ì§€ëŠ” í™˜ê²½ì´ ì´ nogoodì˜ ìƒìœ„ì§‘í•©ì¸ì§€
        #   ë¹ ë¥´ê²Œ ê²€ì‚¬í•˜ê¸° ìœ„í•´ ì¤‘ì•™ í…Œì´ë¸”ì— ë“±ë¡í•œë‹¤.
        #   í…Œì´ë¸”ì€ í¬ê¸°(count)ë³„ë¡œ ì •ë ¬ë˜ì–´ ìˆì–´ì„œ
        #   ì‘ì€ ê²ƒë¶€í„° ë¹ ë¥´ê²Œ ê²€ìƒ‰ ê°€ëŠ¥.
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        print(f"  â”‚")
        print(f"  â”‚  â‘¢ nogood-table ë“±ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        print(f"  â”‚     (insert-in-table nogood-table cenv)")
        print(f"  â”‚")

        self.nogood_table.append(cenv)

        print(f"  â”‚     ë“±ë¡: {cenv}")
        print(f"  â”‚     í˜„ì¬ nogood-table: {self._ng_str()}")
        print(f"  â”‚")
        print(f"  â”‚     ğŸ’¡ ì„¤ê³„ ì˜ë„: ì´í›„ create-env í•  ë•Œë§ˆë‹¤")
        print(f"  â”‚        ì´ í…Œì´ë¸”ê³¼ ëŒ€ì¡°í•´ì„œ 'íƒœì–´ë‚˜ìë§ˆì ê¸ˆì§€'ë¥¼")
        print(f"  â”‚        íŒë³„í•œë‹¤. í¬ê¸°ë³„ ì •ë ¬ë¡œ ê²€ìƒ‰ íš¨ìœ¨ â†‘")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # â‘£ ìƒìœ„ nogood ì •ë¦¬ (Minimize â€” Subsumption Cleanup)
        # ì›ë³¸: (dolist (entry (atms-nogood-table atms))
        #         (when (> (car entry) count) ...
        #           (if (subset-env? cenv old) (delete old ...))))
        #
        # ì„¤ê³„ ì˜ë„:
        #   nogood-tableì˜ "ìµœì†Œì„±" ë¶ˆë³€ëŸ‰ì„ ìœ ì§€í•œë‹¤.
        #   {A,B}ê°€ nogoodì´ë©´ {A,B,C}ë„ ë‹¹ì—°íˆ nogoodì´ë‹¤.
        #   í•˜ì§€ë§Œ {A,B,C}ë¥¼ í…Œì´ë¸”ì— ë‚¨ê²¨ë‘ëŠ” ê±´ ë‚­ë¹„.
        #   â†’ ì‘ì€ ê²ƒì´ ë“±ë¡ë˜ë©´ ê·¸ê²ƒì„ í¬í•¨í•˜ëŠ” í° ê²ƒì„ ì œê±°.
        #
        #   í•µì‹¬: "(> (car entry) count)" â€” ìê¸°ë³´ë‹¤ í° ê²ƒë§Œ ê²€ì‚¬.
        #   ê°™ì€ í¬ê¸°ë‚˜ ì‘ì€ ê²ƒì€ ìê¸°ì˜ ìƒìœ„ì§‘í•©ì¼ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ìŠ¤í‚µ.
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        print(f"  â”‚")
        print(f"  â”‚  â‘£ ìƒìœ„ nogood ì •ë¦¬ (ìµœì†Œì„± ìœ ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        print(f"  â”‚     nogood-tableì—ì„œ cenvì˜ ìƒìœ„ì§‘í•© ì œê±°")
        print(f"  â”‚     ì¡°ê±´: (> count(old) count(cenv)) âˆ§ (cenv âŠ† old)")
        print(f"  â”‚")

        removed = []
        for ng in list(self.nogood_table):
            if ng is not cenv and ng.count > count:
                if cenv.assumptions <= ng.assumptions:
                    removed.append(ng)
                    self.nogood_table.remove(ng)

        if removed:
            for r in removed:
                print(f"  â”‚     {r.assumptions_str()} ì œê±°!")
                print(f"  â”‚       âˆµ {cenv.assumptions_str()} âŠ† {r.assumptions_str()}")
                print(f"  â”‚       â†’ ì‘ì€ ê¸ˆì§€ê°€ ì´ë¯¸ ì»¤ë²„í•˜ë¯€ë¡œ í° ê±´ ë¶ˆí•„ìš”")
            print(f"  â”‚     ì •ë¦¬ í›„: {self._ng_str()}")
        else:
            print(f"  â”‚     ì œê±° ëŒ€ìƒ ì—†ìŒ (ê¸°ì¡´ì— ìƒìœ„ì§‘í•©ì´ ì—†ìŒ)")

        print(f"  â”‚")
        print(f"  â”‚     ğŸ’¡ ì„¤ê³„ ì˜ë„: í…Œì´ë¸”ì„ ìµœì†Œí•œìœ¼ë¡œ ìœ ì§€í•œë‹¤.")
        print(f"  â”‚        {cenv.assumptions_str()} âŠ† X ì´ë©´ XëŠ” ìë™ìœ¼ë¡œ ê¸ˆì§€.")
        print(f"  â”‚        ê²€ì‚¬ ì‹œ ì‘ì€ ê²ƒë§Œ ë³´ë©´ ë˜ë¯€ë¡œ ì†ë„ â†‘")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # â‘¤ ìƒí–¥ ì˜¤ì—¼ (Upward Contamination)
        # ì›ë³¸: (dolist (entry (atms-env-table atms))
        #         (when (> (car entry) count) ...
        #           (when (and (not (env-nogood? old))
        #                      (subset-env? cenv old))
        #             (setf (env-nogood? old) cenv)
        #             (remove-env-from-labels old atms))))
        #
        # ì„¤ê³„ ì˜ë„:
        #   env-table(ëª¨ë“  í™˜ê²½)ì—ì„œ ì´ nogoodì˜ ìƒìœ„ì§‘í•©ì„ ì°¾ì•„
        #   ì „ë¶€ ì˜¤ì—¼ì‹œí‚¨ë‹¤. ì˜¤ì—¼ëœ envë„ labelì—ì„œ ì¦‰ì‹œ ì œê±°.
        #
        #   í•µì‹¬ ì°¨ì´ â€” â‘£ëŠ” nogood-table, â‘¤ëŠ” env-table!
        #     â‘£: ê°™ì€ ê¸ˆì§€ë¼ë¦¬ ì •ë¦¬ (ì¤‘ë³µ ì œê±°)
        #     â‘¤: ì•„ì§ ìœ íš¨í•œ í™˜ê²½ ì¤‘ ìƒìœ„ì§‘í•©ì„ ì˜¤ì—¼ (ì „íŒŒ)
        #
        #   ì´ ë‹¨ê³„ê°€ ì—†ìœ¼ë©´ ì´í›„ weaveì—ì„œ ì˜¤ì—¼ëœ í™˜ê²½ì´
        #   "ìœ íš¨í•œ ì²™" ì‚¬ìš©ë˜ì–´ ì˜ëª»ëœ ì¶”ë¡ ì´ ë°œìƒí•œë‹¤.
        #
        #   ì´ìœ  ì €ì¥: (setf (env-nogood? old) cenv)
        #   "ì™œ ì˜¤ì—¼?"ì— ëŒ€í•œ ë‹µ = "ì´ nogood ë•Œë¬¸ì—"
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        print(f"  â”‚")
        print(f"  â”‚  â‘¤ ìƒí–¥ ì˜¤ì—¼ (env-table ì „ì²´ ê²€ì‚¬) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        print(f"  â”‚     env-tableì—ì„œ cenvì˜ ìƒìœ„ì§‘í•©ì„ ì°¾ì•„ ì˜¤ì—¼")
        print(f"  â”‚     ì¡°ê±´: (> count(e) count(cenv))")
        print(f"  â”‚           âˆ§ (not nogood?(e))")
        print(f"  â”‚           âˆ§ (cenv âŠ† e)")
        print(f"  â”‚")

        contaminated = []
        for e in self.env_table:
            if e is not cenv and not e.is_nogood() and e.count > count:
                if cenv.assumptions <= e.assumptions:
                    # ì˜¤ì—¼!
                    e.nogood = f"âŠ‡{cenv}"
                    # ì´ envì˜ labelë„ ì œê±°
                    for node in list(e.nodes):
                        if e in node.label:
                            node.label.remove(e)
                    e.nodes.clear()
                    contaminated.append(e)

        if contaminated:
            for c in contaminated:
                print(f"  â”‚     {c}")
                old_assumptions = c.assumptions_str()
                print(f"  â”‚       âˆµ {cenv.assumptions_str()} âŠ† {old_assumptions}")
                print(f"  â”‚       â†’ ì´ í™˜ê²½ë„ ëª¨ìˆœ! labelì—ì„œë„ ì œê±°ë¨")
        else:
            print(f"  â”‚     ì˜¤ì—¼ ëŒ€ìƒ ì—†ìŒ")

        print(f"  â”‚")
        print(f"  â”‚     ğŸ’¡ ì„¤ê³„ ì˜ë„: 'í•œ ë²ˆì— ë‹¤ ì²˜ë¦¬' ì›ì¹™.")
        print(f"  â”‚        ë‚˜ì¤‘ì— í•˜ë‚˜ì”© ë°œê²¬í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼")
        print(f"  â”‚        ì§€ê¸ˆ ì¦‰ì‹œ ëª¨ë“  ìƒìœ„ì§‘í•©ì„ ì˜¤ì—¼ì‹œí‚¨ë‹¤.")
        print(f"  â”‚        â‘£ëŠ” nogoodë¼ë¦¬ ì •ë¦¬, â‘¤ëŠ” ì¼ë°˜ env ì˜¤ì—¼.")

    def _ng_str(self) -> str:
        if not self.nogood_table:
            return "[]"
        return "[" + ", ".join(e.assumptions_str() for e in self.nogood_table) + "]"

    def print_state(self, title: str = "") -> None:
        if title:
            print(f"\n  â•â•â• {title} â•â•â•")

        print(f"\n  env-table:")
        for e in self.env_table:
            status = f" âœ— NOGOOD({e.nogood})" if e.is_nogood() else " âœ“ ìœ íš¨"
            refs = ", ".join(n.name for n in e.nodes) if e.nodes else "-"
            print(f"    {e.assumptions_str():<20s}{status:<30s} (label ì°¸ì¡°: {refs})")

        print(f"\n  nogood-table: {self._ng_str()}")

        print(f"\n  ë…¸ë“œ labels:")
        for n in self.nodes:
            tag = " (ê°€ì •)" if n.assumption else ""
            print(f"    {n.name:<8s}{tag:<8s} label = {n.label_str()}")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Mock 1: ê¸°ë³¸ â€” ì²˜ìŒ ë§Œë‚˜ëŠ” nogood
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def mock1():
    """
    ìƒí™©:
      ì˜ì‚¬ê°€ í™˜ìì—ê²Œ ì•½ì„ ì²˜ë°©í•œë‹¤.
      ì•½ Aì™€ ì•½ Bë¥¼ ë™ì‹œì— ë³µìš©í•˜ë©´ ë¶€ì‘ìš©ì´ ìƒê¸´ë‹¤.
      ì´ë¯¸ "A+Bë¥¼ ë³µìš©í•˜ë©´ ì¦ìƒì´ í˜¸ì „ëœë‹¤(D)"ë¼ëŠ” ê²°ë¡ ì´ ìˆì—ˆë‹¤.

      A = ì•½A ë³µìš©,  B = ì•½B ë³µìš©,  C = ì•½C ë³µìš©
      D = "ì¦ìƒ í˜¸ì „" â€” D.label = [E{A,B}]  (A+B ì„¸ê³„ì—ì„œ ì°¸)

      ê·¸ëŸ°ë° ì„ìƒì‹œí—˜ ê²°ê³¼ {A,B}ëŠ” ë¶€ì‘ìš©! â†’ nogood!

    ê¸°ëŒ€:
      - E{A,B}ì— ê¸ˆì§€ ë„ì¥
      - D.labelì—ì„œ E{A,B} ì œê±° â†’ DëŠ” ë” ì´ìƒ ì¦ëª…ë˜ì§€ ì•ŠìŒ
      - nogood-tableì— {A,B} ë“±ë¡
    """
    Env.reset()
    print("=" * 70)
    print("  Mock 1: ê¸°ë³¸ â€” ì²˜ìŒ ë§Œë‚˜ëŠ” ê¸ˆì§€ ì¡°í•©")
    print("=" * 70)
    print("""
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ìƒí™©: ì•½ A + ì•½ B â†’ ì¦ìƒ í˜¸ì „(D)                      â”‚
  â”‚  ë°œê²¬: {A, B} ë™ì‹œ ë³µìš©ì€ ë¶€ì‘ìš©! â†’ nogood!             â”‚
  â”‚                                                        â”‚
  â”‚  í˜„ì¬ ìƒíƒœ:                                            â”‚
  â”‚    A.label = [{A}]                                     â”‚
  â”‚    B.label = [{B}]                                     â”‚
  â”‚    D.label = [{A,B}]  â† "A+B ì„¸ê³„ì—ì„œ Dê°€ ì°¸"         â”‚
  â”‚                                                        â”‚
  â”‚  ì§ˆë¬¸: nogood({A,B}) í›„ D.labelì€?                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)

    atms = ATMS()
    A = atms.make_node("ì•½A", assumption=True)
    B = atms.make_node("ì•½B", assumption=True)
    C = atms.make_node("ì•½C", assumption=True)
    D = atms.make_node("ì¦ìƒí˜¸ì „")

    # DëŠ” A+B ì„¸ê³„ì—ì„œ ì°¸
    e_ab = atms.make_env(frozenset({"ì•½A", "ì•½B"}))
    atms.add_to_label(D, e_ab)

    atms.print_state("nogood ì „")

    print(f"\n  â”€â”€ new-nogood({e_ab.assumptions_str()}, 'ë¶€ì‘ìš©') ì‹¤í–‰!")
    print(f"  â”Œâ”€ new-nogood ì‹œì‘: {e_ab.assumptions_str()}")
    atms.new_nogood(e_ab, "ë¶€ì‘ìš©")
    print(f"  â””â”€ new-nogood ì™„ë£Œ")

    atms.print_state("nogood í›„ ìµœì¢… ìƒíƒœ")

    # ê²€ì¦
    print(f"\n  â”€â”€ ê²€ì¦:")
    assert e_ab.is_nogood()
    print(f"    âœ“ {e_ab.assumptions_str()} is nogood (ì´ìœ : {e_ab.nogood})")
    assert D.label == []
    print(f"    âœ“ ì¦ìƒí˜¸ì „.label = [] â€” ë” ì´ìƒ ì¦ëª…ë˜ì§€ ì•ŠìŒ!")
    print(f"    âœ“ ì•½A.label, ì•½B.labelì€ ì—¬ì „íˆ ìœ íš¨ (ê°œë³„ ì•½ì€ ë¬´í•´)")
    print(f"\n    â˜… í•µì‹¬: 'ì¡°í•©'ì´ ê¸ˆì§€ëœ ê²ƒì´ì§€ 'ê°œë³„ ê°€ì •'ì€ ë¬´ì‚¬!")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Mock 2: ìƒí–¥ ì˜¤ì—¼ â€” ì‘ì€ ê¸ˆì§€ê°€ í° í™˜ê²½ì„ ìë™ ì˜¤ì—¼
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def mock2():
    """
    ìƒí™©:
      íŒ€ í”„ë¡œì íŠ¸ì—ì„œ ê¸°ìˆ ì„ ì„ íƒí•œë‹¤.
      A = React,  B = jQuery,  C = TypeScript

      ê²°ë¡ ë“¤:
        D = "UI ì™„ì„±"      â€” D.label = [{A,B}]     (React+jQueryë¡œ ê°€ëŠ¥)
        E = "í’€ìŠ¤íƒ ì™„ì„±"   â€” E.label = [{A,B,C}]   (React+jQuery+TSë¡œ ê°€ëŠ¥)

      ê·¸ëŸ°ë° ë°œê²¬: React + jQueryëŠ” ì¶©ëŒ! â†’ nogood({A,B})

    ê¸°ëŒ€:
      - {A,B} ê¸ˆì§€
      - D.label ë¹„ì›Œì§
      - {A,B,C}ë„ ìë™ ì˜¤ì—¼! (âˆµ {A,B} âŠ† {A,B,C})
      - E.labelë„ ë¹„ì›Œì§!

    â˜… í•µì‹¬: â‘¤ë²ˆ ë‹¨ê³„(ìƒí–¥ ì˜¤ì—¼)ê°€ ì‘ë™í•˜ëŠ” ì¥ë©´!
    """
    Env.reset()
    print("\n\n" + "=" * 70)
    print("  Mock 2: ìƒí–¥ ì˜¤ì—¼ â€” ì‘ì€ ê¸ˆì§€ê°€ í° í™˜ê²½ì„ ìë™ ì˜¤ì—¼")
    print("=" * 70)
    print("""
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  A = React,  B = jQuery,  C = TypeScript               â”‚
  â”‚                                                        â”‚
  â”‚  D = "UI ì™„ì„±"     label = [{A,B}]                     â”‚
  â”‚  E = "í’€ìŠ¤íƒ ì™„ì„±"  label = [{A,B,C}]                   â”‚
  â”‚                                                        â”‚
  â”‚  ë°œê²¬: React + jQueryëŠ” ì¶©ëŒ! â†’ nogood({A,B})           â”‚
  â”‚                                                        â”‚
  â”‚  ì§ˆë¬¸: {A,B} âŠ† {A,B,C} ì´ë¯€ë¡œ                          â”‚
  â”‚        E{A,B,C}ë„ ìë™ìœ¼ë¡œ ê¸ˆì§€ë˜ëŠ”ê°€?                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)

    atms = ATMS()
    A = atms.make_node("React", assumption=True)
    B = atms.make_node("jQuery", assumption=True)
    C = atms.make_node("TS", assumption=True)
    D = atms.make_node("UIì™„ì„±")
    E = atms.make_node("í’€ìŠ¤íƒ")

    e_ab  = atms.make_env(frozenset({"React", "jQuery"}))
    e_abc = atms.make_env(frozenset({"React", "jQuery", "TS"}))
    atms.add_to_label(D, e_ab)
    atms.add_to_label(E, e_abc)

    atms.print_state("nogood ì „")

    print(f"\n  â”€â”€ new-nogood({e_ab.assumptions_str()}, 'React+jQuery ì¶©ëŒ') ì‹¤í–‰!")
    print(f"  â”Œâ”€ new-nogood ì‹œì‘: {e_ab.assumptions_str()}")
    atms.new_nogood(e_ab, "ì¶©ëŒ")
    print(f"  â””â”€ new-nogood ì™„ë£Œ")

    atms.print_state("nogood í›„ ìµœì¢… ìƒíƒœ")

    # ê²€ì¦
    print(f"\n  â”€â”€ ê²€ì¦:")
    assert e_ab.is_nogood()
    print(f"    âœ“ {{React,jQuery}} is nogood")
    assert e_abc.is_nogood()
    print(f"    âœ“ {{React,jQuery,TS}} is nogood â€” â‘¤ ìƒí–¥ ì˜¤ì—¼!")
    print(f"      â†³ {{React,jQuery}} âŠ† {{React,jQuery,TS}} â†’ ìë™ ì˜¤ì—¼")
    assert D.label == []
    print(f"    âœ“ UIì™„ì„±.label = [] â€” â‘¡ ì§ì ‘ ì œê±°")
    assert E.label == []
    print(f"    âœ“ í’€ìŠ¤íƒ.label = [] â€” â‘¤ì—ì„œ ì—°ì‡„ ì œê±°")
    print()
    print(f"    â˜… í•µì‹¬: â‘¤ë²ˆ ë‹¨ê³„ ë•ë¶„ì— 'ë‚˜ì¤‘ì— ë°œê²¬'ì´ ì•„ë‹ˆë¼")
    print(f"      'ì§€ê¸ˆ ì¦‰ì‹œ' ëª¨ë“  ìƒìœ„ì§‘í•©ì´ ì˜¤ì—¼ëœë‹¤!")
    print(f"      ë§Œì•½ ì´ ë‹¨ê³„ê°€ ì—†ë‹¤ë©´ Eì˜ labelì— ë¬´íš¨í•œ í™˜ê²½ì´ ë‚¨ì•„")
    print(f"      ì´í›„ weaveì—ì„œ ì˜ëª»ëœ ì¶”ë¡ ì´ ì „íŒŒë  ìœ„í—˜!")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Mock 3: ìµœì†Œì„± ì •ë¦¬ â€” ë” ì‘ì€ nogoodì´ í° ê²ƒì„ ëŒ€ì²´
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def mock3():
    """
    ìƒí™©:
      ë¨¼ì € {A,B,C}ê°€ nogoodìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆë‹¤.
      ê·¸ í›„ {A,B}ë„ nogoodì„ì„ ë°œê²¬!

    ê¸°ëŒ€:
      - {A,B}ê°€ ë“±ë¡ë˜ë©´ì„œ {A,B,C}ëŠ” nogood-tableì—ì„œ ì œê±°
      - âˆµ {A,B} âŠ† {A,B,C} â†’ {A,B}ë§Œ ìˆìœ¼ë©´ {A,B,C}ëŠ” ìë™ ì»¤ë²„
      - nogood-tableì€ í•­ìƒ ìµœì†Œ ì§‘í•©ë§Œ ë³´ê´€ (ìµœì†Œì„± ë¶ˆë³€ëŸ‰)

    â˜… í•µì‹¬: â‘£ë²ˆ ë‹¨ê³„(ìƒìœ„ nogood ì •ë¦¬)ê°€ ì‘ë™í•˜ëŠ” ì¥ë©´!
    """
    Env.reset()
    print("\n\n" + "=" * 70)
    print("  Mock 3: ìµœì†Œì„± ì •ë¦¬ â€” ë” ì‘ì€ nogoodì´ í° ê²ƒì„ ëŒ€ì²´")
    print("=" * 70)
    print("""
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ê°€ì • A, B, C                                          â”‚
  â”‚                                                        â”‚
  â”‚  1ë‹¨ê³„: nogood({A,B,C}) ë°œê²¬ â†’ ë“±ë¡                     â”‚
  â”‚  2ë‹¨ê³„: nogood({A,B}) ë°œê²¬   â†’ ë“±ë¡                     â”‚
  â”‚                                                        â”‚
  â”‚  ì§ˆë¬¸: {A,B,C}ëŠ” nogood-tableì— ë‚¨ì•„ìˆëŠ”ê°€?             â”‚
  â”‚                                                        â”‚
  â”‚  ë‹µ: ì•„ë‹ˆë‹¤! {A,B} âŠ† {A,B,C}ì´ë¯€ë¡œ                     â”‚
  â”‚      {A,B}ë§Œ ìˆìœ¼ë©´ {A,B,C}ëŠ” ìë™ ì»¤ë²„ â†’ ì œê±°!        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)

    atms = ATMS()
    A = atms.make_node("A", assumption=True)
    B = atms.make_node("B", assumption=True)
    C = atms.make_node("C", assumption=True)
    P = atms.make_node("P")

    e_abc = atms.make_env(frozenset({"A", "B", "C"}))
    atms.add_to_label(P, e_abc)

    # â”€â”€ 1ë‹¨ê³„: {A,B,C} nogood â”€â”€
    print("  â”€â”€ 1ë‹¨ê³„: nogood({A,B,C}) ë°œê²¬!")
    print(f"  â”Œâ”€ new-nogood ì‹œì‘: {e_abc.assumptions_str()}")
    atms.new_nogood(e_abc, "í°ëª¨ìˆœ")
    print(f"  â””â”€ new-nogood ì™„ë£Œ")

    print(f"\n    nogood-table: {atms._ng_str()}")
    assert len(atms.nogood_table) == 1
    print(f"    â†’ 1ê°œ: {{A,B,C}}")

    # â”€â”€ 2ë‹¨ê³„: {A,B} nogood (ë” ì‘ì€ ê²ƒ ë°œê²¬!) â”€â”€
    e_ab = atms.make_env(frozenset({"A", "B"}))

    print(f"\n  â”€â”€ 2ë‹¨ê³„: nogood({{A,B}}) ë°œê²¬! â€” ë” ê°•ë ¥í•œ ê¸ˆì§€!")
    print(f"  â”Œâ”€ new-nogood ì‹œì‘: {e_ab.assumptions_str()}")
    atms.new_nogood(e_ab, "ì‘ì€ëª¨ìˆœ")
    print(f"  â””â”€ new-nogood ì™„ë£Œ")

    atms.print_state("ìµœì¢… ìƒíƒœ")

    # ê²€ì¦
    print(f"\n  â”€â”€ ê²€ì¦:")
    in_table = [e for e in atms.nogood_table
                if e.assumptions == frozenset({"A", "B", "C"})]
    assert len(in_table) == 0
    print(f"    âœ“ {{A,B,C}}ëŠ” nogood-tableì—ì„œ ì œê±°ë¨!")
    print(f"      â†³ {{A,B}} âŠ† {{A,B,C}} â†’ {{A,B}}ê°€ ì´ë¯¸ ì»¤ë²„")

    assert len(atms.nogood_table) == 1
    print(f"    âœ“ nogood-table = {atms._ng_str()} â€” ìµœì†Œ ì§‘í•©ë§Œ ë³´ê´€")

    assert e_abc.is_nogood()
    print(f"    âœ“ E{{A,B,C}}.is_nogood() = True")
    print(f"      â†³ env ìì²´ì˜ ê¸ˆì§€ ë„ì¥ì€ ê·¸ëŒ€ë¡œ (â‘ ì—ì„œ ì°ì€ ê²ƒ)")
    print(f"      â†³ tableì—ì„œ ë¹ ì¡Œì„ ë¿, env ìì²´ëŠ” ì—¬ì „íˆ nogood")

    print(f"\n    â˜… â‘£ë²ˆê³¼ â‘¤ë²ˆì˜ ì°¨ì´:")
    print(f"      â‘£: nogood-table ì•ˆì—ì„œ í° ê²ƒì„ 'ì •ë¦¬'")
    print(f"         â†’ í…Œì´ë¸”ì„ ìµœì†Œí•œìœ¼ë¡œ ìœ ì§€ (ë©”ëª¨ë¦¬+ê²€ìƒ‰ íš¨ìœ¨)")
    print(f"      â‘¤: env-tableì˜ ìœ íš¨í•œ í™˜ê²½ì„ 'ì˜¤ì—¼'")
    print(f"         â†’ ì•„ì§ ìœ íš¨í•œ ìƒìœ„ í™˜ê²½ì— ê¸ˆì§€ ë„ì¥ + label ì œê±°")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Mock 4: ì‹¤ì „ ì¢…í•© â€” ë‹¤ë‹¨ê³„ ì¶”ë¡  ë„¤íŠ¸ì›Œí¬ì—ì„œì˜ ì—°ì‡„ ë°˜ì‘
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def mock4():
    """
    ìƒí™©:
      ìˆ˜í•™ ì¦ëª… ì‹œìŠ¤í…œ.
      ê³µë¦¬ A, B, C, Dë¥¼ ê°€ì •ìœ¼ë¡œ ì‚¬ìš©.

      ì¶”ë¡  ê²°ê³¼:
        ì •ë¦¬1.label = [{A,B}]       â€” A+Bë¡œ ì¦ëª…
        ì •ë¦¬2.label = [{A,B,C}]     â€” A+B+Cë¡œ ì¦ëª…
        ì •ë¦¬3.label = [{B,C}]       â€” B+Cë¡œ ì¦ëª…
        ì •ë¦¬4.label = [{A,B,D}]     â€” A+B+Dë¡œ ì¦ëª…

      ë°œê²¬: {A,B}ëŠ” ëª¨ìˆœ! (ê³µë¦¬ Aì™€ Bê°€ ì–‘ë¦½ ë¶ˆê°€)

    ê¸°ëŒ€:
      - ì •ë¦¬1.label â†’ [] (ì§ì ‘ ì œê±°)
      - ì •ë¦¬2.label â†’ [] ({A,B,C} ìƒí–¥ ì˜¤ì—¼)
      - ì •ë¦¬3.label â†’ [{B,C}] (ì˜í–¥ ì—†ìŒ! {A,B} âŠ„ {B,C})
      - ì •ë¦¬4.label â†’ [] ({A,B,D} ìƒí–¥ ì˜¤ì—¼)

    â˜… í•µì‹¬: ì •ë¦¬3ë§Œ ì‚´ì•„ë‚¨ëŠ” ì´ìœ ë¥¼ ëª…í™•íˆ ì„¤ëª…!
    """
    Env.reset()
    print("\n\n" + "=" * 70)
    print("  Mock 4: ì‹¤ì „ ì¢…í•© â€” ë‹¤ë‹¨ê³„ ì¶”ë¡  ë„¤íŠ¸ì›Œí¬")
    print("=" * 70)
    print("""
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ê³µë¦¬: A, B, C, D                                        â”‚
  â”‚                                                          â”‚
  â”‚  ì •ë¦¬1.label = [{A,B}]       â† A+Bë¡œ ì¦ëª…                â”‚
  â”‚  ì •ë¦¬2.label = [{A,B,C}]     â† A+B+Cë¡œ ì¦ëª…              â”‚
  â”‚  ì •ë¦¬3.label = [{B,C}]       â† B+Cë¡œ ì¦ëª…                â”‚
  â”‚  ì •ë¦¬4.label = [{A,B,D}]     â† A+B+Dë¡œ ì¦ëª…              â”‚
  â”‚                                                          â”‚
  â”‚  ë°œê²¬: {A, B}ëŠ” ëª¨ìˆœ!                                    â”‚
  â”‚                                                          â”‚
  â”‚  ì–´ë–¤ ì •ë¦¬ê°€ ì‚´ì•„ë‚¨ëŠ”ê°€?                                  â”‚
  â”‚                                                          â”‚
  â”‚  ì˜ˆì¸¡:                                                   â”‚
  â”‚    ì •ë¦¬1 â†’ âœ— ({A,B} ì§ì ‘ í•´ë‹¹)                           â”‚
  â”‚    ì •ë¦¬2 â†’ âœ— ({A,B} âŠ† {A,B,C} â†’ ì˜¤ì—¼)                   â”‚
  â”‚    ì •ë¦¬3 â†’ âœ“ ({A,B} âŠ„ {B,C} â†’ ë¬´ê´€!)                    â”‚
  â”‚    ì •ë¦¬4 â†’ âœ— ({A,B} âŠ† {A,B,D} â†’ ì˜¤ì—¼)                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)

    atms = ATMS()
    A  = atms.make_node("A", assumption=True)
    B  = atms.make_node("B", assumption=True)
    C  = atms.make_node("C", assumption=True)
    D  = atms.make_node("D", assumption=True)
    T1 = atms.make_node("ì •ë¦¬1")
    T2 = atms.make_node("ì •ë¦¬2")
    T3 = atms.make_node("ì •ë¦¬3")
    T4 = atms.make_node("ì •ë¦¬4")

    e_ab  = atms.make_env(frozenset({"A", "B"}))
    e_abc = atms.make_env(frozenset({"A", "B", "C"}))
    e_bc  = atms.make_env(frozenset({"B", "C"}))
    e_abd = atms.make_env(frozenset({"A", "B", "D"}))

    atms.add_to_label(T1, e_ab)
    atms.add_to_label(T2, e_abc)
    atms.add_to_label(T3, e_bc)
    atms.add_to_label(T4, e_abd)

    atms.print_state("nogood ì „")

    print(f"\n  â”€â”€ new-nogood({{A,B}}, 'ê³µë¦¬ì¶©ëŒ') ì‹¤í–‰!")
    print(f"  â”Œâ”€ new-nogood ì‹œì‘: {e_ab.assumptions_str()}")
    atms.new_nogood(e_ab, "ê³µë¦¬ì¶©ëŒ")
    print(f"  â””â”€ new-nogood ì™„ë£Œ")

    atms.print_state("nogood í›„ ìµœì¢… ìƒíƒœ")

    # ê²€ì¦
    print(f"\n  â”€â”€ ê²€ì¦:")
    assert T1.label == []
    print(f"    âœ— ì •ë¦¬1.label = [] â€” â‘¡ ì§ì ‘ ì œê±° (labelì— {{A,B}} ìˆì—ˆìŒ)")

    assert T2.label == []
    print(f"    âœ— ì •ë¦¬2.label = [] â€” â‘¤ ìƒí–¥ ì˜¤ì—¼ ({{A,B}} âŠ† {{A,B,C}})")

    assert len(T3.label) == 1 and T3.label[0].assumptions == frozenset({"B", "C"})
    print(f"    âœ“ ì •ë¦¬3.label = {T3.label_str()} â€” ë¬´ì‚¬! ({{A,B}} âŠ„ {{B,C}})")
    print(f"      â†³ Aê°€ ì—†ìœ¼ë¯€ë¡œ {{A,B}} ê¸ˆì§€ì™€ ë¬´ê´€")

    assert T4.label == []
    print(f"    âœ— ì •ë¦¬4.label = [] â€” â‘¤ ìƒí–¥ ì˜¤ì—¼ ({{A,B}} âŠ† {{A,B,D}})")

    assert not e_bc.is_nogood()
    print(f"    âœ“ E{{B,C}}.is_nogood() = False â€” ê±´ê°•í•œ í™˜ê²½!")

    print(f"""
    â˜… ì •ë¦¬3ë§Œ ì‚´ì•„ë‚¨ì€ ì´ìœ :
      ì •ë¦¬3.label = [{{B,C}}]
      ê¸ˆì§€ ì¡°í•© = {{A,B}}

      ì¡°ê±´: {{A,B}} âŠ† {{B,C}} ?
        A âˆˆ {{B,C}} ? â†’ ì•„ë‹ˆì˜¤! (Aê°€ ì—†ë‹¤)
        â†’ ë¶€ë¶„ì§‘í•© ê´€ê³„ ë¶ˆì„±ë¦½ â†’ ì˜¤ì—¼ ëŒ€ìƒ ì•„ë‹˜!

      ì§ê´€: 'ì•½A+ì•½B'ê°€ ê¸ˆì§€ë¼ê³  í•´ì„œ
            'ì•½B+ì•½C'ê¹Œì§€ ê¸ˆì§€ë˜ì§€ëŠ” ì•ŠëŠ”ë‹¤.
            í•µì‹¬ì€ 'ê¸ˆì§€ ì¡°í•©ì˜ ëª¨ë“  ì›ì†Œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ê°€'ì´ë‹¤.

    â˜… ì €ì de Kleerì˜ ì„¤ê³„ ì›ì¹™:
      â‘¤ë²ˆì€ "ë¶€ë¶„ì§‘í•© ê´€ê³„"ë¡œë§Œ íŒë‹¨í•œë‹¤.
      {A,B} âŠ† Xì¸ í™˜ê²½ Xë§Œ ì˜¤ì—¼ì‹œí‚¤ê³ ,
      ê·¸ ì™¸ëŠ” ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠëŠ”ë‹¤.
      â†’ ì •í™•í•˜ê³  ë³´ìˆ˜ì ì¸(sound) ì²˜ë¦¬.
    """)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ì‹¤í–‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == "__main__":
    mock1()
    mock2()
    mock3()
    mock4()

    print("=" * 70)
    print("  ëª¨ë“  Mock í†µê³¼!")
    print("=" * 70)
    print("""
  â–  ìš”ì•½: new-nogoodì˜ 5ë‹¨ê³„

    â‘                â‘¡                 â‘¢
    ê¸ˆì§€ ë„ì¥ â”€â”€â†’ label ì œê±° â”€â”€â†’ nogood-table ë“±ë¡
    "ì´ í™˜ê²½ì€       "ëª¨ìˆœ ì„¸ê³„ì—ì„œ     "ì¤‘ì•™ ëª©ë¡ì—
     ëª¨ìˆœì´ë‹¤"       ì°¸ì´ë¼ëŠ” ê±´        ë“±ë¡í•´ì„œ
                    ì˜ë¯¸ì—†ë‹¤"          ì´í›„ ê²€ì‚¬ìš©"

                       â‘£                    â‘¤
                â”€â”€â†’ ìƒìœ„ nogood ì •ë¦¬ â”€â”€â†’ ìƒí–¥ ì˜¤ì—¼
                    "í° ê¸ˆì§€ëŠ”           "ìœ íš¨í•œ ìƒìœ„
                     ì‘ì€ ê²Œ ì»¤ë²„í•˜ë‹ˆ     í™˜ê²½ë„ ì „ë¶€
                     ì¤‘ë³µ ì œê±°"           ì¦‰ì‹œ ì˜¤ì—¼!"

  â–  ì €ì de Kleerì˜ í•µì‹¬ ì„¤ê³„ ì›ì¹™:

    1. ë°œìƒ ì‹œì  ì²˜ë¦¬: ë§¤ë²ˆ ì „ìˆ˜ê²€ì‚¬ ì•„ë‹Œ, ë°œìƒ ë•Œ í•œ ë²ˆì— ì „íŒŒ
    2. ìµœì†Œì„± ìœ ì§€:    í…Œì´ë¸”ì— ìµœì†Œ ì§‘í•©ë§Œ â†’ ë©”ëª¨ë¦¬+ì†ë„ ìµœì í™”
    3. ë¶€ë¶„ì§‘í•© íŒì •:  {A,B} âŠ† X ê´€ê³„ë¡œë§Œ ì˜¤ì—¼ â†’ ì •í™•í•˜ê³  ì•ˆì „
    4. ì—­ì°¸ì¡° í™œìš©:    env.nodesë¡œ O(k) ë¹ ë¥¸ label ì •ë¦¬
    5. ì´ìœ  ê¸°ë¡:      'ì™œ ê¸ˆì§€?'ë¥¼ envì— ì €ì¥ â†’ ì„¤ëª… ìƒì„± ê°€ëŠ¥
    """)
